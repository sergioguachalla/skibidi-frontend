<navbar></navbar>

<!-- Lista de Multas -->
<div class="container my-4">
  <h3>Lista de Multas</h3>

  <!-- Filtros de fechas -->
  <div class="row mb-3">
    <div class="col-md-5">
      <label for="startDate">Fecha de inicio:</label>
      <input
        type="date"
        id="startDate"
        class="form-control"
        [(ngModel)]="startDate"
        (change)="filterFines()"
      />
    </div>
    <div class="col-md-5">
      <label for="endDate">Fecha de fin:</label>
      <input
        type="date"
        id="endDate"
        class="form-control"
        [(ngModel)]="endDate"
        (change)="filterFines()"
      />
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" (click)="filterFines()">Filtrar</button>
    </div>
    <div class="col-md-12 mt-3">
      <button class="btn btn-secondary" (click)="clearFilter()">Limpiar filtros</button>
    </div>
  </div>

  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>Tipo de Multa</th>
        <th>Fecha de Vencimiento</th>
        <th>Monto (Bs.)</th>
        <th>Estado</th>
        <th>Usuario</th>
        <th>Fecha de Pago</th>
        <th>Acciones</th>
        <th>Préstamo Permitido</th>
      </tr>
    </thead>
    <tbody>
      <!-- Iteración sobre fines -->
      <tr *ngFor="let fine of fines" [ngClass]="{'gray-row': !fine.canBorrowBooks}">
        <td>{{ fine.fineId }}</td>
        <td>{{ fine.typeFine }}</td>
        <td>{{ fine.dueDate || 'N/A' }}</td>
        <td>{{ fine.amount }}</td>
        <td [ngClass]="{'status-pending': fine.status === 'Pendiente', 'status-paid': fine.status === 'Pagada'}">
          {{ fine.status }}
        </td>
        <td class="username-link" (click)="showFineDetail(fine.fineId)"> {{ fine.username }} </td>
        <td>{{ fine.paidDate }}</td>
        <td class="action-buttons">
          <!-- Botón para bloquear usuarios por daño o pérdida de material -->
          <button 
            *ngIf="fine.typeFine === 'Daño o Pérdida de Material'" 
            class="btn btn-sm btn-danger" 
            title="Bloquear Usuario" 
            (click)="openConfirmModal(fine)">
            <i class="fa fa-ban"></i> {{ fine.isBlocked ? 'Desbloquear Usuario' : 'Bloquear Usuario' }}
          </button>
          <!-- Botón para bloquear/desbloquear préstamos -->
          <button 
            *ngIf="fine.status === 'Pendiente'" 
            class="btn btn-sm" 
            [ngClass]="{'btn-warning': fine.canBorrowBooks, 'btn-success': !fine.canBorrowBooks}" 
            (click)="openConfirmModal(fine)">
            {{ fine.canBorrowBooks ? 'Bloquear Préstamos' : 'Desbloquear Préstamos' }}
          </button>
        </td>
        <td>{{ fine.canBorrowBooks ? 'Sí' : 'No' }}</td>
      </tr>
    </tbody>    
  </table>

  <!-- Paginación -->
  <nav *ngIf="totalPages > 1">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 0">
        <button class="page-link" (click)="onPageChange(currentPage - 1)">Anterior</button>
      </li>
      <li
        class="page-item"
        *ngFor="let page of pagesArray"
        [class.active]="page === currentPage"
      >
        <button class="page-link" (click)="onPageChange(page)">{{ page + 1 }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
        <button class="page-link" (click)="onPageChange(currentPage + 1)">Siguiente</button>
      </li>
    </ul>
  </nav>
</div>

<!-- Modal de Confirmación -->
<div *ngIf="isConfirmModalOpen" class="modal fade show d-block" style="display:block; z-index: 1050;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Acción</h5>
        <button type="button" class="close" (click)="closeConfirmModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Mensaje dinámico basado en la acción -->
        <p *ngIf="selectedFine?.typeFine === 'Daño o Pérdida de Material'">
          ¿Estás seguro de que deseas 
          {{ selectedFine?.isBlocked ? 'bloquear' : 'desbloquear' }} 
          al usuario <strong>{{ selectedFine?.username }}</strong> debido a una multa por daño o pérdida de material?
        </p>
        <p *ngIf="selectedFine?.typeFine !== 'Daño o Pérdida de Material'">
          ¿Estás seguro de que deseas 
          {{ selectedFine?.canBorrowBooks ? 'bloquear' : 'desbloquear' }} 
          los préstamos para el usuario <strong>{{ selectedFine?.username }}</strong>?
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" (click)="confirmBlock()">Confirmar</button>
        <button class="btn btn-secondary" (click)="closeConfirmModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalles de Multa -->
<div *ngIf="isModalOpen" class="modal custom-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h5>Detalles de la Multa para: {{ fineDetail.title }}</h5>
      <button class="close-btn" (click)="closeModal()">×</button>
    </div>
    <div class="modal-body">
      <p><strong>Título:</strong> {{ fineDetail.book.title }}</p>
      <p><strong>Usuario:</strong> {{ fineDetail.username }}</p>
      <p><strong>Días de retraso:</strong> {{ fineDetail.delayDays }}</p>
      <p><strong>Fecha de vencimiento:</strong> {{ fineDetail.dueDate }}</p>
      <p><strong>Monto inicial:</strong> {{ fineDetail.originalAmount }} Bs.</p>
      <p><strong>Monto total con recargos:</strong> {{ fineDetail.totalAmount }} Bs.</p>
      <p><strong>Estado:</strong>
        <span [ngClass]="{'status-pending': fineDetail.status === 'Pending', 'status-paid': fineDetail.status === 'Paid'}">
          {{ fineDetail.status }}
        </span>
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" (click)="closeModal()">Cerrar</button>
    </div>
  </div>
  <div class="modal-overlay" (click)="closeModal()"></div>
</div>
